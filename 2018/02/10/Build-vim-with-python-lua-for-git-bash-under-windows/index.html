<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description"><link rel="stylesheet" type="text/css" href="/css/azw.css"></head><body><div id="header"><ul class="title-menu"><li><a class="nav" href="/">Home</a></li><li><a class="nav" href="/tags">Tags</a></li><li><a class="nav" href="/categories">Category</a></li><li><a class="nav" href="/archives">Archive</a></li><li><input id="search-site" placeholder="Search..."></li></ul><div class="post-header-wrapper"><div class="post-header"><div class="post-title">Build vim with python, lua for git bash under windows</div><div class="post-meta"><div class="post-date">2018-02-10 20:14:50</div><div class="post-tag"><a class="nav tag" href="/tags/vim/">vim</a><a class="nav tag" href="/tags/msys/">msys</a><a class="nav tag" href="/tags/python/">python</a></div></div></div></div></div><hr><div id="content-wrapper"><div id="content"><p>On how to build vim for git-bash with lua, python, python3 feathers.</p>
<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>Git-bash comes with a set of commandline tool that ALMOST satisfy all my needs, it even has a up-to-date vim included, which says:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">VIM - Vi IMproved 8.0 (2016 Sep 12, compiled Dec 14 2017 09:34:59)</span><br><span class="line">包含补丁: 1-1305</span><br><span class="line">编译者 chen_x@DESKTOP-S3M9UF8</span><br><span class="line">巨型版本 无图形界面。  可使用(+)与不可使用(-)的功能:</span><br><span class="line">+acl             +comments        +farsi           +langmap         +mouse_netterm   +printer         +tag_binary      +visual</span><br><span class="line">+arabic          +conceal         +file_in_path    +libcall         +mouse_sgr       +profile         +tag_old_static  +visualextra</span><br><span class="line">+autocmd         +cryptv          +find_in_path    +linebreak       -mouse_sysmouse  +python/dyn      -tag_any_white   +viminfo</span><br><span class="line">-autoservername  +cscope          +float           +lispindent      +mouse_urxvt     +python3/dyn     -tcl             +vreplace</span><br><span class="line">-balloon_eval    +cursorbind      +folding         +listcmds        +mouse_xterm     +quickfix        +termguicolors   +wildignore</span><br><span class="line">-browse          +cursorshape     -footer          +localmap        +multi_byte      +reltime         +terminal        +wildmenu</span><br><span class="line">++builtin_terms  +dialog_con      +fork()          +lua             +multi_lang      +rightleft       +terminfo        +windows</span><br><span class="line">+byte_offset     +diff            +gettext         +menu            -mzscheme        +ruby/dyn        +termresponse    +writebackup</span><br><span class="line">+channel         +digraphs        -hangul_input    +mksession       +netbeans_intg   +scrollbind      +textobjects     -X11</span><br><span class="line">+cindent         -dnd             +iconv           +modify_fname    +num64           +signs           +timers          -xfontset</span><br><span class="line">-clientserver    -ebcdic          +insert_expand   +mouse           +packages        +smartindent     +title           -xim</span><br><span class="line">+clipboard       +emacs_tags      +job             -mouseshape      +path_extra      +startuptime     -toolbar         -xpm</span><br><span class="line">+cmdline_compl   +eval            +jumplist        +mouse_dec       +perl/dyn        +statusline      +user_commands   -xsmp</span><br><span class="line">+cmdline_hist    +ex_extra        +keymap          -mouse_gpm       +persistent_undo -sun_workshop    +vertsplit       -xterm_clipboard</span><br><span class="line">+cmdline_info    +extra_search    +lambda          -mouse_jsbterm   +postscript      +syntax          +virtualedit     -xterm_save</span><br><span class="line">     系统 vimrc 文件: &quot;/etc/vimrc&quot;</span><br><span class="line">     用户 vimrc 文件: &quot;$HOME/.vimrc&quot;</span><br><span class="line"> 第二用户 vimrc 文件: &quot;~/.vim/vimrc&quot;</span><br><span class="line">      用户 exrc 文件: &quot;$HOME/.exrc&quot;</span><br><span class="line">       defaults file: &quot;$VIMRUNTIME/defaults.vim&quot;</span><br><span class="line">         $VIM 预设值: &quot;/usr/share/vim&quot;</span><br><span class="line">编译方式: gcc -c -I. -Iproto -DHAVE_CONFIG_H   -I/usr/include/ncursesw  -g -O2 -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=1</span><br><span class="line">链接方式: gcc   -L. -pipe -fstack-protector  -L/usr/local/lib -Wl,--as-needed -o vim.exe        -lm    -lncursesw -liconv -lacl -lintl  -L/usr/local/l</span><br><span class="line">ib -llua -Wl,--enable-auto-import -Wl,--export-all-symbols -Wl,--enable-auto-image-base -fstack-protector-strong  -L/usr/lib/perl5/core_perl/CORE -lpe</span><br><span class="line">rl -lpthread -ldl -lcrypt</span><br></pre></td></tr></table></figure>
<p>But according to <a href="https://github.com/git-for-windows/git/issues/827" target="_blank" rel="noopener">this issue</a>, there would be no python in the official git-for-windows releases, it causes many popular plugins unable to work under git-bash vim. Some people <a href="https://stackoverflow.com/questions/33519853/how-do-i-add-python-support-in-vim-in-git-bash" target="_blank" rel="noopener">suggested</a> to use msys instead.</p>
<p>I tried, but encountered some other problem, like  <a href="https://stackoverflow.com/questions/11693074/git-credential-cache-is-not-a-git-command" target="_blank" rel="noopener">git-credential-cache</a>. It bores me to get msysgit work as git-for-windows, then I tried to compile my vim for git-bash.</p>
<p>As a newbee, I struggled days to figure out that msys and mingw are quiet different things, finally make my way out to get my vim with python/python3/lua under git-bash. Here are the steps.</p>
<h1 id="Install-msys64"><a href="#Install-msys64" class="headerlink" title="Install msys64"></a>Install msys64</h1><p>Download msys2-x86_64-<em>yyyymmdd</em>.exe from <a href="http://www.msys2.org/" target="_blank" rel="noopener">Msys2</a> and install to <code>c:\msys64</code>.</p>
<p>We can make some convinent settings(optional):</p>
<p>Start the msys shell and enter the following lines:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF&gt;&gt; /etc/minttyrc</span><br><span class="line">BoldAsFont=yes</span><br><span class="line">Columns=150</span><br><span class="line">Rows=50</span><br><span class="line">Font=Source Code Pro</span><br><span class="line">FontHeight=10</span><br><span class="line">Transparency=off</span><br><span class="line">OpaqueWhenFocused=no</span><br><span class="line">CursorType=underscore</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">echo &quot;alias ls=&apos;ls --color&apos;&quot; &gt;&gt; /etc/bash.bashrc</span><br></pre></td></tr></table></figure>
<p>Associate msys shell in windows right-button menu(optional):</p>
<p>Create an <code>a.reg</code> file as following and import into the windows regestry:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\Background\shell\msys]</span><br><span class="line">@=&quot;Open MSYS64 here&quot;</span><br><span class="line">&quot;Icon&quot;=&quot;C:\\dev_tools\\msys64\\msys2.ico&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\Background\shell\msys\command]</span><br><span class="line">@=&quot;C:\\dev_tools\\msys64\\msys2_shell.cmd -here&quot;</span><br></pre></td></tr></table></figure></p>
<p>Add pacman mirrors(optional):</p>
<p>In the msys shell, run the following commands:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;1i Server = http://mirrors.ustc.edu.cn/msys2/mingw/i686&apos; /etc/pacman.d/mirrorlist.mingw32</span><br><span class="line">sed -i &apos;1i Server = http://mirrors.ustc.edu.cn/msys2/mingw/x86_64&apos; /etc/pacman.d/mirrorlist.mingw64</span><br><span class="line">sed -i &apos;1i Server = http://mirrors.ustc.edu.cn/msys2/msys/$arch&apos; /etc/pacman.d/mirrorlist.msys</span><br></pre></td></tr></table></figure></p>
<p>Synchronize package databases with <code>pacman -Syu</code>. May need to kill the terminal and re-run <code>pacman -Su</code>.</p>
<p>Install dev packages:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S base-devel binutils python3 ruby ncurses-devel libcrypt-devel gcc</span><br></pre></td></tr></table></figure>
<h1 id="Build-vim-from-source"><a href="#Build-vim-from-source" class="headerlink" title="Build vim from source:"></a>Build vim from source:</h1><p>I choose to build from <a href="https://github.com/Alexpux/MSYS2-packages/vim" target="_blank" rel="noopener">Package scripts for MSYS2 </a>, for it is quit update-to-date and with patches to work friendly under msys.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># if you don&apos;t have msysgit, run the next command under git-bash</span><br><span class="line">git clone https://github.com/Alexpux/MSYS2-packages.git</span><br><span class="line"></span><br><span class="line"># the following comamnds run under msys</span><br><span class="line">cd MSYS2-packages/vim</span><br><span class="line">makepkg</span><br></pre></td></tr></table></figure>
<p>Package vim:</p>
<p>The previous step do created a vim package for pacman, but git-bash dosn’t have one. So pack for ourself:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd MSYS2-packages/vim/src</span><br><span class="line">make DESTDIR=/d/downloads/vim_install install</span><br><span class="line">cd /d/downloads/vim_install</span><br><span class="line">tar zcf vim_install.tar.gz ./ /usr/lib/python* /usr/bin/msys-python*.dll</span><br></pre></td></tr></table></figure>
<h1 id="Copy-vim-to-git-bash"><a href="#Copy-vim-to-git-bash" class="headerlink" title="Copy vim to git-bash"></a>Copy vim to git-bash</h1><p>In git-bash, run the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf /d/downloads/vim_install/vim_install.tar.gz -C /</span><br></pre></td></tr></table></figure>
<p>Now start vim from git-bash and run simple test:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:py3 print(2+1)</span><br></pre></td></tr></table></figure></p>
<h1 id="Next-steps"><a href="#Next-steps" class="headerlink" title="Next steps"></a>Next steps</h1><p>Configure vim, setup plugins like vundle, youcompleteme, etc.</p>
</div><div id="side-nav"><div class="side-widget"><div class="side-widget-toc"><div class="widget-title">toc</div><div class="widget"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Preface"><span class="toc-number">1.</span> <span class="toc-text">Preface</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Install-msys64"><span class="toc-number">2.</span> <span class="toc-text">Install msys64</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Build-vim-from-source"><span class="toc-number">3.</span> <span class="toc-text">Build vim from source:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Copy-vim-to-git-bash"><span class="toc-number">4.</span> <span class="toc-text">Copy vim to git-bash</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Next-steps"><span class="toc-number">5.</span> <span class="toc-text">Next steps</span></a></li></ol></div></div></div></div></div><button onclick="topFunction()" id="gotopButton" title="Go to top 11">&#x27A4;</button><script>// When the user scrolls down 20px from the top of the document, show the button
window.onscroll = function() {scrollFunction()};

function scrollFunction() {
    if (document.body.scrollTop > 60 || document.documentElement.scrollTop > 60) {
        document.getElementById("gotopButton").style.display = "block";
    } else {
        document.getElementById("gotopButton").style.display = "none";
    }
}

// When the user clicks on the button, scroll to the top of the document
function topFunction() {
    document.body.scrollTop = 0; // For Safari
    document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
}</script></body></html>