<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description"><link rel="stylesheet" type="text/css" href="/css/azw.css"></head><body><div id="header"><ul class="title-menu"><li><a class="nav" href="/">Home</a></li><li><a class="nav" href="/tags">Tags</a></li><li><a class="nav" href="/categories">Category</a></li><li><a class="nav" href="/archives">Archive</a></li><li><input id="search-site" placeholder="Search..."></li></ul><div class="post-header-wrapper"><div class="post-header"><div class="post-title">Integrate all-self-hosted drone.io with gitea</div><div class="post-meta"><div class="post-date">2018-03-27 08:30:55</div><div class="post-tag"><a class="nav tag" href="/tags/drone-io/">drone.io</a><a class="nav tag" href="/tags/gitea/">gitea</a><a class="nav tag" href="/tags/ci/">ci</a></div></div></div></div></div><hr><div id="content-wrapper"><div id="content"><p>“<a href="https://drone.io" target="_blank" rel="noopener">Drone.io</a> is an open source Continuous Delivery platform that automates your testing and release workflows”. Drone has built in integration with many source code management systems, like Github, Gitlabs, Gogs and Gitea, Coding has an integration instruction in drone’s document too. Drone is docker based, size of the two required image(drone/server, drone/agent) sum up to only 50MB and less, it has pretty modern ui, which attached me at the firet grance.</p>
<p><a href="https://gitea.io" target="_blank" rel="noopener">Gitea</a> is forked from <a href="https://gogs.io" target="_blank" rel="noopener">Gogs</a>, they are almost identical, even the “A painless self-hosted git service” annoncement. They both actually are what they annonced, Gogs is small(less then 160MB docker image), while Gitea is even smaller(70MB), that’s why I perfer Gitea.</p>
<p>This article is about how to setup an all selfhosted continuous delivery environment with drone.io and gitea.</p>
<h1 id="The-site-map"><a href="#The-site-map" class="headerlink" title="The site map"></a>The site map</h1><p>We have at least a gitea server and a drone server, for convinent, a web server should be included. We shall access all the services from the host machine, and the servers able connect to each other. </p>
<p>For host machine’s access to the serivces, we can expose all service ports to host machine, then we can visit them via “localhost:3000”, “localhost:5000”, etc, that’s ugly. I tried to mount services under sub directories like “localhost/gitea”, “localhost/drone”, but end up with that drone does not support mounnting to a sub directory. Subdomain is the rescure. I hacked my hosts file and setup nginx reverse proxy to archive this.</p>
<p>the hosts file of the host machine:</p>
<blockquote>
<p>127.0.0.1       <a href="http://www.xin.me" target="_blank" rel="noopener">www.xin.me</a><br>127.0.0.1       xin.me<br>127.0.0.1       gogs.xin.me<br>127.0.0.1       gitea.xin.me<br>127.0.0.1       jenkins.xin.me<br>127.0.0.1       drone.xin.me<br>127.0.0.1       demo.xin.me</p>
</blockquote>
<p>the nginx conf of the nginx container, which exposes port 80:<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim:set ft=nginx:</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> xin.local www.xin.local _; <span class="comment"># your_server_ip</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Prevent ipv6 resolve in docker</span></span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">127.0.0.1</span> ipv6=<span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/www.access.log main;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/www.<span class="literal">error</span>.log <span class="literal">warn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span>   /www/nginx/html;</span><br><span class="line">        <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> drone.xin.local;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://drone-server:8000;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_buffering</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">chunked_transfer_encoding</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> gitea.xin.local;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Prevent ipv6 resolve in docker</span></span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">127.0.0.1</span> ipv6=<span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/gitea.access.log main;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/gitea.<span class="literal">error</span>.log <span class="literal">warn</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">client_max_body_size</span> <span class="number">100m</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://gitea:3000/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Most above config were copied from drone and gitea’s document, I am not going to discuss about them indepth here.</p>
<h1 id="The-compose-file"><a href="#The-compose-file" class="headerlink" title="The compose file"></a>The compose file</h1><p>Drone itself starts up with at lease 2 containers, one drone server and one or more drone agent, official document suggests run them by docker compose. With the same compose file we setup our nginx reverse proxy server and PostgreSQL(for gitea) together. </p>
<h2 id="Networks"><a href="#Networks" class="headerlink" title="Networks"></a>Networks</h2><p>First we define two internal networks, a “www” network to connect all the exposed service, including nginx, gitea and drone, with the nginx server holding domain and subdomain names like “xin.local”, “drone.xin.local”, docker automaticlly assign a short host name to each service, like “gitea”, “drone”, so nginx can proxy to them by name instead of static assigned ip address. Part of the compose file looks like:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  www:</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  www:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="attr">nginx:alpine</span></span><br><span class="line"><span class="attr">  restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"80:80"</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">./data/log/nginx:/var/log/nginx</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">./conf/nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line"><span class="attr">    - www:</span><span class="string">/www</span></span><br><span class="line"><span class="attr">  depends_on:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">drone-server</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">gitea</span></span><br><span class="line"><span class="attr">  networks:</span></span><br><span class="line"><span class="attr">    www:</span></span><br><span class="line"><span class="attr">      aliases:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">xin.local</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">gitea.xin.local</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">drone.xin.local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  drone:</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      www:</span></span><br><span class="line"><span class="attr">  gitea:</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      www:</span></span><br></pre></td></tr></table></figure>
<p>In this config, when drone service want’s access gitea, it visits “<a href="http://gitea.xin.local&quot;" target="_blank" rel="noopener">http://gitea.xin.local&quot;</a>, which resolves to the nginx server, then nginx proxies the request to “http:gitea:3000” according to the previous nginx config, thus we make drone and gitea access each other through nginx reverse proxy, with the same domain name as the host machine.<br>The above config also mounts host volumes for nginx log and config, we shall had created the log directory and put the nginx config we described in the first part of this articl into the config directory. And the named volume <em>www</em> is to persistantly hold static files, e.g. my hexo blog. We shall add named volumes to save persistant data for each service.</p>
<p>We also defined the dependicy for nginx, it should wait for drone-server and gitea start first, or nginx might complain site unaccessable and exit.</p>
<h2 id="Drone-service"><a href="#Drone-service" class="headerlink" title="Drone service"></a>Drone service</h2><p>Drone has a sample compose file for integrate with gitea, we can simply copy it and make some changes according to our environment. </p>
<p>You should notice the <code>DRONE_NETWORK</code> line. If not explicitly defined, drone will create a new network for containers in pipeline, and that network will not be able to resolve our <em>gitea.xin.local</em> domain, that makes pipline fail on git clone stage. Thankfully we can assign one in compose file, as the following:</p>
<p>Another config option not in the drone’s sample configure is the <code>DRONE_ADMIN</code>. If you need to mount volumes in pipline, e.g. cache build result, use copy to deploy, etc, you must set the repository to <strong>Trusted</strong> in repository setting, which only avaliable to drone admin user.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">drone-server:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">drone/drone</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - drone:</span><span class="string">/var/lib/drone/</span></span><br><span class="line"><span class="attr">  restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  environment:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DRONE_ADMIN=xin</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DRONE_OPEN=true</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DRONE_HOST=http://drone.xin.local</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DRONE_GITEA=true</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DRONE_GITEA_URL=http://gitea.xin.local</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DRONE_SECRET=c676-9241-d916-3d6a</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DRONE_NETWORK=devstack_www</span></span><br><span class="line"><span class="attr">  networks:</span></span><br><span class="line"><span class="attr">    www:</span></span><br><span class="line"><span class="attr">    postgres:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">drone-agent:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">drone/agent</span></span><br><span class="line"><span class="attr">  command:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">  restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  depends_on:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">drone-server</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="attr">  environment:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DRONE_SERVER=drone-server:9000</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DRONE_SECRET=c676-9241-d916-3d6a</span></span><br><span class="line"><span class="attr">  networks:</span></span><br><span class="line"><span class="attr">    www:</span></span><br></pre></td></tr></table></figure>
<p>In the above config, we make drone use our <em>devstack_www</em> network, which is the <em>www</em> network in compose file’s network section. Docker automatically append dirname to network name, in my case the directory holding my <em>docker-compose.yml</em> is <em>devstack</em>. We have to set the full name of the network so drone will use it for pipelines. If you are not sure what’s the correct name of that network, you can run <code>docker network ls</code> after the compose up. Ofcause you can create an isolated network for pipelines, just make gitea connect to it with the same domain name.</p>
<p>Almost done, now what we should care about is all above. For the full docker compose file, see the end of this article.</p>
<h1 id="the-pipline"><a href="#the-pipline" class="headerlink" title="the pipline "></a>the pipline </h1><p>Let’s create our first pipeline. First we copy the sample nodejs pipeline from drone’s documents, then add npm and other required mirror configs to environment variables(Thanks to the greet fakking woll), mount our deploy target volume, and specify our build and deploy commands.</p>
<p>Note in the publish state I used <code>ls -alR public</code> to see what’s actually generated, and <code>env | grep DRONE</code> to see what can we get from drone during pipeline.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pipeline:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">node:8-alpine</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">npm_config_registry=https://registry.npm.taobao.org/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">SQLITE3_BINARY_SITE=http://npm.taobao.org/mirrors/sqlite3</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ELECTRON_MIRROR=http://npm.taobao.org/mirrors/electron</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">SASS_BINARY_SITE=http://npm.taobao.org/mirrors/node-sass</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">phantomjs_cdnurl=https://npm.taobao.org/mirrors/phantomjs/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CHROMEDRIVER_CDNURL=http://npm.taobao.org/mirrors/chromedriver</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">SELENIUM_CDNURL=http://npm.taobao.org/mirrorss/selenium</span></span><br><span class="line"><span class="attr">    commands:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"><span class="attr">  publish:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">alpine</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - devstack_www:</span><span class="string">/www</span></span><br><span class="line"><span class="attr">    commands:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">mkdir</span> <span class="bullet">-p</span> <span class="string">/www/nginx/html</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ls</span> <span class="bullet">-alR</span> <span class="string">public</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">env</span> <span class="string">| grep DRONE</span></span><br><span class="line"><span class="string">      - cp -ur public/* /www/nginx/html/</span></span><br></pre></td></tr></table></figure>
<h1 id="Up-and-test"><a href="#Up-and-test" class="headerlink" title="Up and test"></a>Up and test</h1><p>All done, it’s time to test it out:</p>
<ul>
<li><code>docker-compose up</code> to bring up the services</li>
<li>configure gitea and add the first repo</li>
<li>login to drone, and activate the repo</li>
<li>goto gitea and see authorized application in account setting, and webhook in repository setting</li>
<li>config the repo as <strong>trusted</strong></li>
<li>do webhook test from gitea, or push new commits to gitea.</li>
<li>see what’s going on in drone.</li>
</ul>
<h1 id="What’s-nest"><a href="#What’s-nest" class="headerlink" title="What’s nest"></a>What’s nest</h1><ul>
<li>cache to accelarate build</li>
<li>build status notify</li>
<li>build badges and reports</li>
<li>common delever method(ssh/rsync/git release..etc)</li>
</ul>
<h1 id="The-full-docker-compose-file"><a href="#The-full-docker-compose-file" class="headerlink" title="The full docker-compose file"></a>The full docker-compose file</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  gitea:</span></span><br><span class="line"><span class="attr">  pg:</span></span><br><span class="line"><span class="attr">  www:</span></span><br><span class="line"><span class="attr">  drone:</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  www:</span></span><br><span class="line"><span class="attr">  postgres:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  www:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">nginx:alpine</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"80:80"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./data/log/nginx:/var/log/nginx</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./conf/nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line"><span class="attr">      - www:</span><span class="string">/www</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">drone-server</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">gitea</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      www:</span></span><br><span class="line"><span class="attr">        aliases:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">xin.local</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">gitea.xin.local</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">drone.xin.local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  postgres:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">chenxinaz/pg_jieba:alpine</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">POSTGRES_PASSWORD=asdfasdf123</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - pg:</span><span class="string">/var/lib/postgresql/data</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./conf/postgres/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      postgres:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  gitea:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">gitea/gitea</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - gitea:</span><span class="string">/data</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      www:</span></span><br><span class="line"><span class="attr">      postgres:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  drone-server:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">drone/drone</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - drone:</span><span class="string">/var/lib/drone/</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DRONE_ADMIN=xin</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DRONE_OPEN=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DRONE_HOST=http://drone.xin.local</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DRONE_GITEA=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DRONE_GITEA_URL=http://gitea.xin.local</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DRONE_SECRET=c676-9241-d916-3d6a</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DRONE_NETWORK=devstack_www</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      www:</span></span><br><span class="line"><span class="attr">      postgres:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  drone-agent:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">drone/agent</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">agent</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">drone-server</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DRONE_SERVER=drone-server:9000</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DRONE_SECRET=c676-9241-d916-3d6a</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      www:</span></span><br></pre></td></tr></table></figure>
</div><div id="side-nav"><div class="side-widget"><div class="side-widget-toc"><div class="widget-title">toc</div><div class="widget"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#The-site-map"><span class="toc-number">1.</span> <span class="toc-text">The site map</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-compose-file"><span class="toc-number">2.</span> <span class="toc-text">The compose file</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Networks"><span class="toc-number">2.1.</span> <span class="toc-text">Networks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Drone-service"><span class="toc-number">2.2.</span> <span class="toc-text">Drone service</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#the-pipline"><span class="toc-number">3.</span> <span class="toc-text">the pipline </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Up-and-test"><span class="toc-number">4.</span> <span class="toc-text">Up and test</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#What’s-nest"><span class="toc-number">5.</span> <span class="toc-text">What’s nest</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-full-docker-compose-file"><span class="toc-number">6.</span> <span class="toc-text">The full docker-compose file</span></a></li></ol></div></div></div></div></div><button onclick="topFunction()" id="gotopButton" title="Go to top 11">&#x27A4;</button><script>// When the user scrolls down 20px from the top of the document, show the button
window.onscroll = function() {scrollFunction()};

function scrollFunction() {
    if (document.body.scrollTop > 60 || document.documentElement.scrollTop > 60) {
        document.getElementById("gotopButton").style.display = "block";
    } else {
        document.getElementById("gotopButton").style.display = "none";
    }
}

// When the user clicks on the button, scroll to the top of the document
function topFunction() {
    document.body.scrollTop = 0; // For Safari
    document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
}</script></body></html>